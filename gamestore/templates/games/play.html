
{% extends 'base.html' %}

{% block title %}
GameStop - {{game.title}}
{% endblock %}

{% block script_jquery %}
<script>
/* Source https://docs.djangoproject.com/en/dev/ref/csrf/ */
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
function csrfSafeMethod(method) {
  // these HTTP methods do not require CSRF protection
  return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
  beforeSend: function(xhr, settings) {
    var csrftoken = getCookie('csrftoken');
    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    }
  }
});

/* global $ */
$(document).ready(function() {
  'use strict';
  $(window).on('message', function(evt) {
    //Note that messages from all origins are accepted
    var url = ($(location). attr("href"));
    var url_split = url.split('/');
    var game_id = url_split[url_split.length-2];

    /* Get data from sent message
     * Message types from game to service: SCORE, SAVE, LOAD_REQUEST, SETTING */
    var data = evt.originalEvent.data;
    console.log(data.messageType);
    switch (data.messageType) {
      case 'SCORE':
        console.log(data.score);
        $.ajax({
          type:"POST",
          url:"/player/update_game_data/",
          data: {
            'gameId' : game_id,
            'messageType': 'SCORE',
            'score': data.score,
          },
          success: function(){
            $('#message').text("Score Updated!");
          }
        });
        break;
      case 'SAVE':
        console.log(data.gameState);
        /* $.ajax({
          type:"POST",
          url:"/player/update_game_data/",
          data: {
            'gameId' : game_id,
            'messageType': 'SAVE',
            'score': data.gameState,
          },
          success: function(){
            $('#message').text("Score Updated!");
          }
        });*/
        break;
      case 'LOAD_REQUEST':
        console.log(data.messageType);
        /* Send LOAD */
        break;
      case 'SETTING':
        $('#iframeWrapper').width(data.options.width);
        $('#iframeWrapper').height(data.options.height);
        console.log($('#iframeWrapper').width());
        console.log($('#iframeWrapper').height());
        break;
      default:
        break;
    }
  });
});
</script>
{% endblock %}

{% block content %}
<div class="row">
  <div id="iframeWrapper" class="center-block" style="width:900px;"> <br><br>
    <div class="embed-responsive embed-responsive-16by9">
    <iframe  src="{{game.url}}" class="embed-responsive-item " />
    </div>
  </div>
  <div class="center-block" style="width:500px;"> <br>
    <p class="lead" id="message">Play!</p>
  </div>
</div>
{% endblock %}
